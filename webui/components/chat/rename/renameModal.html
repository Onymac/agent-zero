<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rename Chat</title>
    <link rel="stylesheet" href="/index.css">
    <link rel="stylesheet" href="/components/chat/rename/renameModal.css">
    
    <script type="module">
        import { createStore } from "/js/AlpineStore.js";
        
        const model = {
            isOpen: false,
            chatId: null,
            currentName: '',
            newName: '',
            isLoading: false,
            isTask: false, // New property to track if this is a task
            
            open(chatId, currentName, isTask = false) {
                this.chatId = chatId;
                this.currentName = currentName;
                this.newName = currentName;
                this.isTask = isTask;
                this.isOpen = true;
                // Use setTimeout to ensure DOM is ready
                setTimeout(() => {
                    const input = document.getElementById('rename-input');
                    if (input) {
                        input.focus();
                        input.select();
                    }
                }, 100);
            },
            
            close() {
                this.isOpen = false;
                this.chatId = null;
                this.currentName = '';
                this.newName = '';
                this.isLoading = false;
                this.isTask = false;
            },
            
            async save() {
                if (!this.newName.trim() || this.newName.trim() === this.currentName) {
                    this.close();
                    return;
                }
                
                this.isLoading = true;
                
                try {
                    // Call the global rename function
                    if (globalThis.renameChatWithModal) {
                        await globalThis.renameChatWithModal(this.chatId, this.newName.trim());
                        this.close();
                    } else {
                        console.error('renameChatWithModal function not found');
                        this.isLoading = false;
                    }
                } catch (error) {
                    console.error('Error renaming chat:', error);
                    this.isLoading = false;
                }
            },
            
            handleKeydown(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    this.save();
                } else if (event.key === 'Escape') {
                    event.preventDefault();
                    this.close();
                }
            }
        };
        
        const store = createStore("renameModal", model);
        export { store };
    </script>
</head>

<body>
    <div x-data>
        <template x-if="$store.renameModal">
            <!-- Modal Backdrop -->
            <div x-show="$store.renameModal.isOpen" 
                 x-cloak
                 class="rename-modal-backdrop"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 @click="$store.renameModal.close()">
                
                <!-- Modal Content -->
                <div class="rename-modal-content" 
                     @click.stop
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 transform scale-95"
                     x-transition:enter-end="opacity-100 transform scale-100"
                     x-transition:leave="transition ease-in duration-200"
                     x-transition:leave-start="opacity-100 transform scale-100"
                     x-transition:leave-end="opacity-0 transform scale-95">
                    
                    <!-- Header -->
                    <div class="rename-modal-header">
                        <h3 class="rename-modal-title" x-text="$store.renameModal.isTask ? 'Rename Task' : 'Rename Chat'"></h3>
                        <button class="rename-modal-close" 
                                @click="$store.renameModal.close()"
                                :disabled="$store.renameModal.isLoading">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Body -->
                    <div class="rename-modal-body">
                        <label for="rename-input" class="rename-input-label" x-text="$store.renameModal.isTask ? 'Task Name' : 'Chat Name'"></label>
                        <input type="text" 
                               id="rename-input"
                               class="rename-input"
                               x-model="$store.renameModal.newName"
                               @keydown="$store.renameModal.handleKeydown($event)"
                               :disabled="$store.renameModal.isLoading"
                               :placeholder="$store.renameModal.isTask ? 'Enter task name...' : 'Enter chat name...'">
                    </div>
                    
                    <!-- Footer -->
                    <div class="rename-modal-footer">
                        <button class="rename-btn rename-btn-secondary" 
                                @click="$store.renameModal.close()"
                                :disabled="$store.renameModal.isLoading">
                            Cancel
                        </button>
                        <button class="rename-btn rename-btn-primary" 
                                @click="$store.renameModal.save()"
                                :disabled="$store.renameModal.isLoading || !$store.renameModal.newName.trim()">
                            <span x-show="!$store.renameModal.isLoading">Save</span>
                            <span x-show="$store.renameModal.isLoading" class="loading-spinner">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 12a9 9 0 11-6.219-8.56"/>
                                </svg>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>
</body>
</html>